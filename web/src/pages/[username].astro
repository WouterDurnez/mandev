---
import BaseLayout from '../layouts/BaseLayout.astro';
import TerminalNav from '../components/TerminalNav.astro';

const { username } = Astro.params;
const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:8000';

interface Skill {
  name: string;
  level: 'beginner' | 'intermediate' | 'advanced' | 'expert';
}

interface Project {
  name: string;
  repo?: string;
  url?: string;
  description?: string;
}

interface Experience {
  role: string;
  company: string;
  start: string;
  end?: string;
  description?: string;
}

interface Link {
  label: string;
  url: string;
  icon?: string;
}

interface Theme {
  scheme?: string;
  font?: string;
  mode?: string;
}

interface Layout {
  sections?: string[];
}

interface Profile {
  name: string;
  tagline?: string;
  about?: string;
  avatar?: string;
}

interface GitHubLanguage {
  name: string;
  percentage: number;
  color: string;
}

interface GitHubRepo {
  name: string;
  description?: string;
  stars: number;
  forks: number;
  language?: string;
  language_color?: string;
  url: string;
}

interface GitHubStatsData {
  total_stars: number;
  total_repos: number;
  followers: number;
  total_contributions: number;
  current_streak: number;
  longest_streak: number;
  languages: GitHubLanguage[];
  pinned_repos: GitHubRepo[];
  contributions: { date: string; count: number }[];
}

interface GitHubConfig {
  username: string;
  show_heatmap?: boolean;
  show_stats?: boolean;
  show_languages?: boolean;
  show_pinned?: boolean;
}

interface ProfileData {
  username?: string;
  profile?: Profile;
  theme?: Theme;
  layout?: Layout;
  skills?: Skill[];
  projects?: Project[];
  experience?: Experience[];
  links?: Link[];
  github?: GitHubConfig;
  github_stats?: GitHubStatsData | null;
  github_verified?: boolean;
  view_count?: number;
}

let profileData: ProfileData | null = null;
let error: number | null = null;

try {
  const res = await fetch(`${API_URL}/api/profile/${username}`);
  if (res.ok) {
    profileData = await res.json() as ProfileData;
  } else {
    error = res.status;
  }
} catch {
  error = 500;
}

const scheme = profileData?.theme?.scheme || 'dracula';
const font = profileData?.theme?.font || 'JetBrains Mono';
const profile = profileData?.profile;
const sections = profileData?.layout?.sections || ['bio', 'skills', 'projects', 'experience', 'links'];

const BAR_WIDTH = 20;
const fillMap: Record<string, number> = {
  beginner: 0.25,
  intermediate: 0.5,
  advanced: 0.75,
  expert: 1.0,
};

function skillBar(level: string): string {
  const fill = Math.round(BAR_WIDTH * (fillMap[level] || 0));
  const empty = BAR_WIDTH - fill;
  return '\u2588'.repeat(fill) + '\u2591'.repeat(empty);
}

const githubConfig = profileData?.github;
const githubStats = profileData?.github_stats;

function heatmapOpacity(count: number): number {
  if (count === 0) return 0.1;
  if (count < 3) return 0.3;
  if (count < 5) return 0.6;
  return 1.0;
}

const MONTH_NAMES = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

interface MonthLabel {
  name: string;
  col: number;
}

function getMonthLabels(contributions: { date: string; count: number }[]): MonthLabel[] {
  if (contributions.length === 0) return [];
  const labels: MonthLabel[] = [];
  let lastMonth = -1;
  for (let i = 0; i < contributions.length; i++) {
    const col = Math.floor(i / 7);
    const month = new Date(contributions[i].date).getMonth();
    if (month !== lastMonth) {
      labels.push({ name: MONTH_NAMES[month], col });
      lastMonth = month;
    }
  }
  return labels;
}

const monthLabels = githubStats ? getMonthLabels(githubStats.contributions) : [];

const uname = (username || '').toUpperCase();
---

<BaseLayout
  title={profile ? `${profile.name} — man.dev` : `${username} — man.dev`}
  scheme={scheme}
  font={font}
  ogTitle={profile ? `${profile.name} — man.dev` : undefined}
  ogDescription={profile?.tagline || undefined}
  ogImage={profile ? `https://man.dev/${username}.png` : undefined}
  ogUrl={profile ? `https://man.dev/${username}` : undefined}
>
  <TerminalNav items={[{ label: 'home', href: '/' }, { label: 'login', href: '/login' }, { label: 'signup', href: '/signup' }]} />
  <main class="max-w-terminal mx-auto px-4 pt-16 pb-8 text-sm font-mono">
    {error || !profileData || !profile ? (
      <div class="py-16">
        <p class="text-terminal-dim mb-2">$ man {username}</p>
        <p class="text-terminal-fg">No manual entry for {username}</p>
      </div>
    ) : (
      <div class="space-y-6">
        {/* Man page header */}
        <pre class="text-terminal-accent text-xs">
{`${uname}(7)${' '.repeat(Math.max(1, 54 - uname.length * 2 - 14))}man.dev Manual${' '.repeat(Math.max(1, 54 - uname.length * 2 - 14))}${uname}(7)`}
        </pre>

        {sections.map((section: string) => {
          if (section === 'bio') {
            return (
              <div>
                {profile.avatar && (
                  <div class="mb-4 avatar-pixel-wrap">
                    <img
                      src={profile.avatar}
                      alt={`${profile.name} avatar`}
                    />
                  </div>
                )}
                <h2 class="text-terminal-accent text-xs uppercase tracking-widest mb-1">Name</h2>
                <p class="pl-8">
                  <span class="text-terminal-fg font-bold">{profile.name}</span>
                  {profile.tagline && (
                    <span class="text-terminal-dim"> &mdash; {profile.tagline}</span>
                  )}
                </p>
                {profile.about && (
                  <div class="mt-4">
                    <h2 class="text-terminal-accent text-xs uppercase tracking-widest mb-1">Description</h2>
                    <p class="pl-8 text-terminal-dim leading-relaxed whitespace-pre-line">{profile.about}</p>
                  </div>
                )}
              </div>
            );
          }

          if (section === 'skills' && profileData.skills && profileData.skills.length > 0) {
            return (
              <div>
                <h2 class="text-terminal-accent text-xs uppercase tracking-widest mb-1">Skills</h2>
                <div class="pl-8 space-y-1">
                  {profileData.skills.map((skill: Skill) => (
                    <div class="flex items-center gap-2">
                      <span class="w-24 shrink-0 text-terminal-fg truncate">{skill.name}</span>
                      <span class="text-terminal-accent">{skillBar(skill.level)}</span>
                      <span class="text-terminal-dim text-xs">{skill.level}</span>
                    </div>
                  ))}
                </div>
              </div>
            );
          }

          if (section === 'projects' && profileData.projects && profileData.projects.length > 0) {
            return (
              <div>
                <h2 class="text-terminal-accent text-xs uppercase tracking-widest mb-1">Projects</h2>
                <div class="pl-8 space-y-3">
                  {profileData.projects.map((project: Project) => (
                    <div>
                      <p class="text-terminal-fg font-bold">{project.name}</p>
                      {project.description && (
                        <p class="text-terminal-dim pl-4 text-xs">{project.description}</p>
                      )}
                      {project.url && (
                        <p class="pl-4 text-xs">
                          <a href={project.url} class="text-terminal-accent hover:underline" target="_blank" rel="noopener noreferrer">{project.url}</a>
                        </p>
                      )}
                      {project.repo && !project.url && (
                        <p class="pl-4 text-xs">
                          <a href={project.repo} class="text-terminal-accent hover:underline" target="_blank" rel="noopener noreferrer">{project.repo}</a>
                        </p>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            );
          }

          if (section === 'experience' && profileData.experience && profileData.experience.length > 0) {
            return (
              <div>
                <h2 class="text-terminal-accent text-xs uppercase tracking-widest mb-1">Experience</h2>
                <div class="pl-8 space-y-3">
                  {profileData.experience.map((exp: Experience) => (
                    <div>
                      <p class="text-terminal-fg">
                        {exp.role} at {exp.company}{' '}
                        <span class="text-terminal-dim">
                          ({exp.start}&ndash;{exp.end || 'present'})
                        </span>
                      </p>
                      {exp.description && (
                        <p class="text-terminal-dim pl-4 text-xs">{exp.description}</p>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            );
          }

          if (section === 'links' && profileData.links && profileData.links.length > 0) {
            return (
              <div>
                <h2 class="text-terminal-accent text-xs uppercase tracking-widest mb-1">See Also</h2>
                <div class="pl-8 space-y-0.5">
                  {profileData.links.map((link: Link) => (
                    <p>
                      <span class="text-terminal-dim">{link.label}:</span>{' '}
                      <a href={link.url} class="text-terminal-accent hover:underline" target="_blank" rel="noopener noreferrer">{link.url}</a>
                    </p>
                  ))}
                </div>
              </div>
            );
          }

          return null;
        })}

        {/* GitHub section */}
        {githubStats && (
          <div>
            {githubConfig?.show_stats !== false && (
              <div>
                <h2 class="text-terminal-accent text-xs uppercase tracking-widest mb-1">
                  GitHub
                  {profileData.github_verified && (
                    <span class="ml-2" style="font-size: 0.65rem; border: 1px solid var(--accent); padding: 1px 6px; vertical-align: middle;">
                      verified
                    </span>
                  )}
                </h2>
                <div class="pl-8">
                  <p>
                    <span class="text-terminal-dim">Stars: </span><span class="text-terminal-fg">{githubStats.total_stars.toLocaleString()}</span>
                    <span class="text-terminal-dim ml-4">Repos: </span><span class="text-terminal-fg">{githubStats.total_repos.toLocaleString()}</span>
                    <span class="text-terminal-dim ml-4">Followers: </span><span class="text-terminal-fg">{githubStats.followers.toLocaleString()}</span>
                    <span class="text-terminal-dim ml-4">Contributions: </span><span class="text-terminal-fg">{githubStats.total_contributions.toLocaleString()}</span>
                  </p>
                  <p class="mt-1">
                    <span class="text-terminal-dim">Current streak: </span><span class="text-terminal-fg">{githubStats.current_streak.toLocaleString()} days</span>
                    <span class="text-terminal-dim ml-4">Longest: </span><span class="text-terminal-fg">{githubStats.longest_streak.toLocaleString()} days</span>
                  </p>
                </div>
              </div>
            )}

            {githubConfig?.show_heatmap !== false && githubStats.contributions.length > 0 && (
              <div class={githubConfig?.show_stats !== false ? 'mt-4' : ''}>
                {githubConfig?.show_stats === false && (
                  <h2 class="text-terminal-accent text-xs uppercase tracking-widest mb-1">
                    GitHub
                    {profileData.github_verified && (
                      <span class="ml-2" style="font-size: 0.65rem; border: 1px solid var(--accent); padding: 1px 6px; vertical-align: middle;">
                        verified
                      </span>
                    )}
                  </h2>
                )}
                <div class="pl-8 mt-2" style="overflow-x: auto;">
                  <div style="display: inline-block; position: relative;">
                    <div style="display: flex; font-size: 0.5rem; line-height: 1; color: var(--dim); margin-bottom: 2px;">
                      {monthLabels.map((label, i) => {
                        const nextCol = i + 1 < monthLabels.length ? monthLabels[i + 1].col : Math.ceil(githubStats.contributions.length / 7);
                        const span = nextCol - label.col;
                        return (
                          <span style={`width: ${span * 10}px; flex-shrink: 0;`}>{label.name}</span>
                        );
                      })}
                    </div>
                    <div style="display: inline-grid; grid-template-rows: repeat(7, 1fr); grid-auto-flow: column; gap: 2px; font-size: 0.5rem; line-height: 1;">
                      {githubStats.contributions.map((day) => (
                        <span style={`color: var(--accent); opacity: ${heatmapOpacity(day.count)};`} title={`${day.date}: ${day.count}`}>{'\u2588'}</span>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            )}

            {githubConfig?.show_languages !== false && githubStats.languages.length > 0 && (
              <div class="mt-4">
                <h2 class="text-terminal-accent text-xs uppercase tracking-widest mb-1">Languages</h2>
                <div class="pl-8 mt-2">
                  <div style="display: flex; width: 100%; height: 8px; border-radius: 2px; overflow: hidden;">
                    {githubStats.languages.map((lang) => (
                      <div style={`width: ${lang.percentage}%; background: ${lang.color};`} title={`${lang.name} ${lang.percentage}%`}></div>
                    ))}
                  </div>
                  <div class="mt-2 flex flex-wrap gap-x-4 gap-y-1 text-xs">
                    {githubStats.languages.map((lang) => (
                      <span class="text-terminal-dim">
                        <span style={`color: ${lang.color};`}>{'\u25cf'}</span> {lang.name} {lang.percentage}%
                      </span>
                    ))}
                  </div>
                </div>
              </div>
            )}

            {githubConfig?.show_pinned !== false && githubStats.pinned_repos.length > 0 && (
              <div class="mt-4">
                <h2 class="text-terminal-accent text-xs uppercase tracking-widest mb-1">Pinned Repositories</h2>
                <div class="pl-8 space-y-3">
                  {githubStats.pinned_repos.map((repo) => (
                    <div>
                      <div class="flex items-baseline justify-between gap-4">
                        <a href={repo.url} class="text-terminal-fg font-bold hover:underline" target="_blank" rel="noopener noreferrer">{repo.name}</a>
                        <span class="text-terminal-dim text-xs whitespace-nowrap">
                          {'\u2605'} {repo.stars.toLocaleString()}  {'\u2442'} {repo.forks.toLocaleString()}
                        </span>
                      </div>
                      {repo.description && (
                        <p class="text-terminal-dim pl-4 text-xs">{repo.description}</p>
                      )}
                      {repo.language && (
                        <p class="pl-4 text-xs">
                          {repo.language_color && (
                            <span style={`color: ${repo.language_color};`}>{'\u25cf'} </span>
                          )}
                          <span class="text-terminal-accent">{repo.language}</span>
                        </p>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        )}

        {/* Output formats */}
        <div>
          <h2 class="text-terminal-accent text-xs uppercase tracking-widest mb-1">Output</h2>
          <div class="pl-8 space-y-0.5">
            <p>
              <span class="text-terminal-dim">json:</span>{' '}
              <a href={`/${username}.json`} class="text-terminal-accent hover:underline">/{username}.json</a>
            </p>
            <p>
              <span class="text-terminal-dim">text:</span>{' '}
              <a href={`/${username}.txt`} class="text-terminal-accent hover:underline">/{username}.txt</a>
            </p>
            <p>
              <span class="text-terminal-dim">svg:</span>{' '}
              <a href={`/${username}.svg`} class="text-terminal-accent hover:underline">/{username}.svg</a>
            </p>
          </div>
        </div>

        {profileData.view_count != null && profileData.view_count > 0 && (
          <p class="text-terminal-dim text-xs mt-4">
            viewed {profileData.view_count.toLocaleString()} times
          </p>
        )}

        {/* Man page footer */}
        <pre class="text-terminal-dim text-xs mt-8">
{`man.dev                    ${new Date().getFullYear()}                     ${uname}(7)`}
        </pre>
      </div>
    )}
  </main>
</BaseLayout>
